---
layout: post
title: following HBC pipeline - qualimap and salmon
date: '2023-06-27'
categories: coding
tags: [coding]
---

I keep returning to this GitHub page time and time again, and it continues to be the best resource I can find to explain to me **why** certain tools are used, as well as provide citations for tested tools that improve accuracy and precision over others. Here is the link to the overview: https://github.com/hbctraining/DGE_workshop_salmon_online/blob/master/lessons/01a_RNAseq_processing_workflow.md 

So although samtools and stringtie could be good things to use, I'm just going to try to follow the HBC training from now on because it seems to be in agreement with the current bioinformatics literature. STAR keeps coming up as a good option for genomic alignment of reads, and Salmon is the top performer in terms of quantifying expression using lightweight alignment. So I'll move forward with that (unless it doesn't work at all on Pegasus).

This is directly from the training:

"**5. Quality control of aligned sequence reads (STAR/Qualimap)**
As mentioned above, the differential gene expression analysis will use transcript/gene pseudocounts generated by Salmon. However, to perform some basic quality checks on the sequencing data, it is important to align the reads to the whole genome. Either STAR or HiSAT2 are able to perform this step and generate a BAM file that can be used for QC.

A tool called Qualimap explores the features of aligned reads in the context of the genomic region they map to, hence providing an overall view of the data quality (as an HTML file). Various quality metrics assessed by Qualimap include:
- DNA or rRNA contamination
- 5'-3' biases
- Coverage biases"

So, I have the BAM files from using STAR to perform read alignment to the whole genome. So next lets install qualimap (http://qualimap.conesalab.org/). 

```{bash}
wget https://bitbucket.org/kokonech/qualimap/downloads/qualimap_v2.3.zip
unzip qualimap_v2.3.zip

cd qualimap_v2.3/
source qualimap # this didn't work
make qualimap # this didn't work
```

there is no source file for qualimap like there was for STAR so maybe I don't need to compile it? I'll just try running it and see how it goes.

```{bash}
cd /scratch/projects/and_transcriptomics/Allyson_CCC/aligned
/scratch/projects/and_transcriptomics/programs/qualimap_v2.3/qualimap
```
I tried running the /scratch/projects/and_transcriptomics/programs/qualimap_v2.3/qualimap line directly in the command line after moving to the Allyson_CCC/aligned folder, and it came out with this error: "Can't connect to X11 window server using ':0.0' as the value of the DISPLAY variable."

I think actually maybe what's happening is that qualimap is a GUI (graphical user interface) so when I try to run it in Pegasus it can't export it to a desktop for me to view it. So I think I actually need to download the .bam files so that they're local and then run qualimap on my computer. 

but which .bam do I use? Aligned.sortedByCoord.out.bam versus Aligned.toTranscriptome.out.bam?

Ok wait I found this [thread](https://hbctraining.github.io/Intro-to-rnaseq-hpc-salmon/lessons/03_QC_STAR_and_Qualimap_run.html#qualimap) that explains how by default Qualimap will try to open a GUI. so you need to run the "unset DISPLAY" command in the terminal. I also need to add the location of Qualimap to the PATH variable. When I open my bash profile, I think I have the PATH variable updated to include everything in the programs folder because I have this line: "export PATH=$PATH:/scratch/projects/and_transcriptomics/programs".

Ok, when I do that I still get the same error. But on the [HBC training link](https://hbctraining.github.io/Intro-to-rnaseq-hpc-salmon/lessons/03_QC_STAR_and_Qualimap_run.html#qualimap) it said to specify "rnaseq" when running qualimap, and when I do that I get a different error message so that's progress I guess. I'm going to try to submit a job similar to what they have.

Ok so for using qualimap rnaseq you specifically need a GTF file, not a [GFF file](http://qualimap.conesalab.org/doc_html/analysis.html#rna-seq-qc) . So I am going to try using bamqc instead to get general region quality results.

```{bash}
#!/bin/bash
#BSUB -J qualimap
#BSUB -q general
#BSUB -P and_transcriptomics
#BSUB -n 8
#BSUB -o qualimap%J.out
#BSUB -e qualimap%J.err
#BSUB -u and128@miami.edu
#BSUB -N

and="/scratch/projects/and_transcriptomics"

cd "/scratch/projects/and_transcriptomics/Allyson_CCC/aligned"

data=($(ls *Aligned.sortedByCoord.out.bam))

for sample in ${data[@]} ;

do \
${and}/programs/qualimap_v2.3/qualimap bamqc \
-outdir ${and}/Allyson_CCC/aligned \ 
-bam ${and}/Allyson_CCC/aligned/${sample} \ 
-gff ${and}/genomes/Acer/Acerv_assembly_v1.0.gff3 \  ; \

done
```

I keep getting java errors, maybe I need to load a java module before running.

```{bash}
#!/bin/bash
#BSUB -J qualimap
#BSUB -q general
#BSUB -P and_transcriptomics
#BSUB -n 8
#BSUB -o qualimap%J.out
#BSUB -e qualimap%J.err
#BSUB -u and128@miami.edu
#BSUB -N

and="/scratch/projects/and_transcriptomics"

cd "/scratch/projects/and_transcriptomics/Allyson_CCC/aligned"

data=($(ls *Aligned.sortedByCoord.out.bam))

module load java/7
module load R/4.1.0

for sample in ${data[@]} ;

do \
${and}/programs/qualimap_v2.3/qualimap bamqc \
-bam ${and}/Allyson_CCC/aligned/${sample} \
-outdir ${and}/Allyson_CCC/aligned \  
-gff ${and}/genomes/Acer/Acerv_assembly_v1.0.gff3 \  ; \

done
```

Ok I think I got it to work!

A couple things to note: 
1) the code I wrote 
